meta {
  name: CreateProviderParticipant
  type: http
  seq: 1
}

post {
  url: {{PROVIDER_IDHUB_ID_API}}/v1alpha/participants
  body: json
  auth: inherit
}

headers {
  x-api-key: YWRtaW4.adminKey
}

body:json {
  {
      "roles":[],
      "serviceEndpoints":[{
        "id": "ConsumerCredentialService-ID",
        "type": "CredentialService", 
        "serviceEndpoint": "http://provider-idhub:13131/api/credentials/v1/participants/{{B64_PROV_ID}}"
      }],
      "active": true,
      "participantId": "{{PROV_ID}}",
      "did": "{{PROV_ID}}",
      "key":{
          "keyId": "{{PROV_ID}}#key-1",
          "privateKeyAlias": "{{PROV_ID}}-alias",
          "keyGeneratorParams":{
              "algorithm": "EdDSA",
              "curve": "Ed25519"
          }
      }
  }
}

script:pre-request {
  const btoa = require("btoa");
  const prov_id = bru.getEnvVar("PROV_ID");
  bru.setEnvVar("B64_PROV_ID", btoa(prov_id));
}

script:post-response {
  const apiKey = res.getBody().apiKey.trim();
  if (apiKey) {
    bru.setEnvVar("PROVIDER_IH_APIKEY", apiKey);
  }
  const stsSecret = res.getBody().clientSecret.trim();
  if (stsSecret) {
    bru.setEnvVar("PROVIDER_STS_SECRET", stsSecret)
  }
}

settings {
  encodeUrl: true
  timeout: 0
}
